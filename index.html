<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·è€…é‹å‹•å¤§å¯Œç¿</title>
    <!-- å¼•å…¥ Tailwind CSS CDN (ç”¨æ–¼æ¨£å¼è¨­è¨ˆ) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React/ReactDOM CDN (ç”¨æ–¼å»ºç«‹å…ƒä»¶) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- å¼•å…¥ Babel æ‰èƒ½ç·¨è­¯ JSX (åœ¨ç€è¦½å™¨ä¸­é‹è¡Œ React) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- ä¿®æ­£: ç§»é™¤ lucide-reactï¼Œæ”¹ç”¨ lucide æ ¸å¿ƒå‡½å¼åº«ä¾†æ‰‹å‹•å‰µå»º SVG å…ƒä»¶ -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥ä¿æŒç¾ä»£æ„Ÿ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* è®“å…§å®¹åœ¨ç§»å‹•è¨­å‚™ä¸Šä½”æ»¿é«˜åº¦ï¼Œé¿å…åœ¨ä¸»é«”æ²å‹• */
            height: 100vh;
            overflow: hidden; 
        }
        /* å®šç¾©æ£‹ç›¤çš„ Grid çµæ§‹ */
        .board-grid {
            grid-template-columns: repeat(6, minmax(0, 1fr));
            grid-template-rows: repeat(6, minmax(0, 1fr));
        }
    </style>
</head>
<body>
    <!-- React æ‡‰ç”¨ç¨‹å¼çš„æ ¹ç¯€é» -->
    <div id="root"></div>

    <script type="text/babel">
        // ----------------------------------------------------------------
        // 1. å¼•å…¥ Lucide icons å’Œ React Hooks (å·²ä¿®æ­£ç‚ºæ‰‹å‹• SVG è½‰æ›)
        // ----------------------------------------------------------------
        
        // å–å¾— Lucide æ ¸å¿ƒåœ–ç¤ºè³‡æ–™
        const Lucide = window.lucide || { icons: {} }; 
        const { useState, useEffect, useCallback } = React;
        
        // è¼”åŠ©å‡½å¼ï¼šå°‡ Lucide åœ–ç¤ºåç¨±è½‰æ›ç‚ºå¯ç”¨çš„ React Component
        const createIconComponent = (name) => {
            const iconData = Lucide.icons[name];
            if (!iconData) {
                // å¦‚æœåœ–ç¤ºæœªæ‰¾åˆ°ï¼Œè¿”å›ä¸€å€‹ç°¡å–®çš„å•è™Ÿä½”ä½ç¬¦
                return ({ className = '', size = 24 }) => <span className={className} style={{fontSize: `${size}px`}}>â“</span>;
            }

            // ä½¿ç”¨ SVG å…§å®¹ä½œç‚º React Component
            const IconComponent = ({ className = '', size = 24 }) => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                    dangerouslySetInnerHTML={{ __html: iconData.contents.join('') }}
                />
            );
            return IconComponent;
        };

        // å®šç¾©æ‰€æœ‰éœ€è¦çš„åœ–ç¤ºå…ƒä»¶
        const Trophy = createIconComponent('trophy');
        const Users = createIconComponent('users');
        const Activity = createIconComponent('activity');
        const Brain = createIconComponent('brain');
        const Heart = createIconComponent('heart');
        const Star = createIconComponent('star');
        const CheckCircle = createIconComponent('check-circle');
        const XCircle = createIconComponent('x-circle');
        const RotateCcw = createIconComponent('rotate-ccw');
        const Play = createIconComponent('play');
        const Swords = createIconComponent('swords');
        const Flame = createIconComponent('flame');

        // ----------------------------------------------------------------
        // 2. éŠæˆ²è³‡æ–™è¨­å®š (èˆ‡åŸ React æª”æ¡ˆç›¸åŒ)
        // ----------------------------------------------------------------

        const TILE_TYPES = {
            START: { label: 'èµ·é»', color: 'bg-green-600', icon: Star },
            EXERCISE: { label: 'å‹•å‹•æ‰‹è…³', color: 'bg-orange-500', icon: Activity },
            QUIZ: { label: 'å¥åº·è…¦åŠ›', color: 'bg-blue-500', icon: Brain },
            SOCIAL: { label: 'æ­¡æ¨‚äº’å‹•', color: 'bg-pink-500', icon: Users },
            CHANCE: { label: 'æ©Ÿæœƒå‘½é‹', color: 'bg-purple-500', icon: Trophy },
            REST: { label: 'å–æ°´ä¼‘æ¯', color: 'bg-teal-500', icon: Heart },
            ATTACK: { label: 'æ”»æ“Šå¡', color: 'bg-red-600', icon: Swords },
        };

        const TASK_DATABASE = {
            // ğŸ’ª EXERCISEï¼šå‹•å‹•æ‰‹è…³ (é‹å‹•é¡)
            EXERCISE: [
                { text: "é›™æ‰‹å‘ä¸Šèˆ‰é«˜ï¼Œæ·±å‘¼å¸ä¸‰æ¬¡", points: 20 },
                { text: "åŸåœ°è¸æ­¥ 30 ç§’", points: 30 },
                { text: "é›™æ‰‹å‘å‰ä¼¸ç›´ï¼Œæ‰‹æŒé–‹åˆ 10 æ¬¡", points: 20 },
                { text: "è½‰å‹•è‚©è†€ï¼Œå‘å‰ 5 åœˆï¼Œå‘å¾Œ 5 åœˆ", points: 20 },
                { text: "åå§¿æŠ¬è†è“‹ï¼Œå·¦å³å„ 5 æ¬¡", points: 30 },
                { text: "é›™æ‰‹æ’è…°ï¼Œèº«é«”å·¦å³è¼•è¼•è½‰å‹•", points: 20 },
                { text: "æ¨¡ä»¿ã€Œæ¸¸è›™å¼ã€çš„å‹•ä½œ 5 æ¬¡", points: 25 },
                { text: "é›™æ‰‹æ¯”ã€Œè®šã€ï¼Œå‘å‰ä¼¸å±•æ‰‹è‡‚", points: 15 },
            ],
            // ğŸ§  QUIZï¼šå¥åº·è…¦åŠ› (å•ç­”é¡)
            QUIZ: [
                { text: "è«‹å•ä¸€å¤©å»ºè­°å–å¤šå°‘æ°´ï¼Ÿ (1) 500cc (2) 2000cc", answer: "ç­”æ¡ˆï¼š(2) 2000cc", points: 20 },
                { text: "é‹å‹•å‰è¦åšä»€éº¼äº‹å¯ä»¥é é˜²å—å‚·ï¼Ÿ", answer: "ç­”æ¡ˆï¼šæš–èº«é‹å‹•", points: 20 },
                { text: "é é˜²è·Œå€’ï¼Œå®¶è£¡åœ°æ¿æ‡‰è©²ä¿æŒï¼Ÿ(1) æ¿•æ»‘ (2) ä¹¾ç‡¥", answer: "ç­”æ¡ˆï¼š(2) ä¹¾ç‡¥", points: 15 },
                { text: "å¿ƒæƒ…ä¸å¥½æ™‚ï¼Œæ‰¾æœ‹å‹èŠå¤©æœ‰å¹«åŠ©å—ï¼Ÿ", answer: "ç­”æ¡ˆï¼šéå¸¸æœ‰å¹«åŠ©ï¼", points: 15 },
                { text: "é€™å¥æˆèªæ¥é¾ï¼šã€Œèº«é«”...ã€", answer: "ç­”æ¡ˆï¼šèº«é«”å¥åº·", points: 30 },
            ],
            // ğŸ¤ SOCIALï¼šæ­¡æ¨‚äº’å‹• (ç¤¾äº¤é¡)
            SOCIAL: [
                { text: "å…¨éšŠä¸€èµ·å°éš”å£éšŠä¼æ¯”å€‹ã€Œæ„›å¿ƒã€æ‰‹å‹¢", points: 30 },
                { text: "è«‹å…¨éšŠä¸€èµ·å¤§ç¬‘ä¸‰è²ã€Œå“ˆï¼å“ˆï¼å“ˆï¼ã€", points: 25 },
                { text: "å¹«ä½ å³é‚Šçš„å¤¥ä¼´æ¥æ¥èƒŒ", points: 30 },
                { text: "å…¨éšŠä¸€èµ·å¤§å–Šï¼šã€Œæˆ‘å€‘æœ€å¥åº·ï¼ã€", points: 20 },
                { text: "èˆ‡å¦ä¸€éšŠçš„ä¸€ä½ä»£è¡¨æ¡æ‰‹æˆ–æ“ŠæŒ", points: 25 },
                { text: "å…¨éšŠä¸€èµ·å”±å…©å¥å¤§å®¶éƒ½æœƒçš„æ­Œ (å¦‚: ç”œèœœèœœ)", points: 50 },
            ],
            // ğŸ† CHANCEï¼šæ©Ÿæœƒå‘½é‹ (é‹æ°£é¡)
            CHANCE: [
                { text: "æ­å–œï¼ç›´æ¥ç²å¾—åŠ åˆ†ï¼", points: 50 },
                { text: "å¤ªæ£’äº†ï¼å…¨é«”éšŠå“¡èµ·ç«‹æ¥å—æŒè²", points: 30 },
                { text: "ä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·çš„è·¯ï¼Œæš«åœä¸€å›åˆ (ä½†ä¹ŸåŠ  10 åˆ†)", points: 10 },
                { text: "éª°å­é»æ•¸åŠ å€é€åˆ†ï¼", points: 40 },
            ],
            // âš”ï¸ ATTACKï¼šæ”»æ“Šå¡ (äº’å‹•/æ‰£åˆ†é¡)
            ATTACK: [
                { text: "ç™¼å‹•æ”»æ“Šï¼ä¸‹ä¸€é †ä½çš„éšŠä¼æ‰£ 10 åˆ†ï¼", points: -10, effect: 'NEXT' },
                { text: "å¤ªå¼·äº†ï¼ç›®å‰æœ€é«˜åˆ†çš„éšŠä¼æ‰£ 20 åˆ†ï¼", points: -20, effect: 'LEADER' },
                { text: "å…¨é«”æ”»æ“Šï¼é™¤äº†æˆ‘å€‘ä»¥å¤–ï¼Œå…¶ä»–éšŠä¼å„æ‰£ 5 åˆ†ï¼", points: -5, effect: 'OTHERS' },
                { text: "è¸©åˆ°é¦™è•‰çš®ï¼è‡ªå·±æ‰£ 10 åˆ†...", points: -10, effect: 'SELF' },
                { text: "æŒ‡å®šæ”»æ“Šï¼šè«‹è€å¸«å¹«å¿™æ‰£ä¸Šä¸€éšŠ 15 åˆ†ï¼", points: -15, effect: 'PREV' },
            ]
        };

        // åœ°åœ–ç”Ÿæˆ (20æ ¼)
        const generateBoard = () => {
            const board = [];
            const types = [
                'EXERCISE', 'ATTACK', 'SOCIAL', 'EXERCISE', 
                'CHANCE', 'EXERCISE', 'ATTACK', 'QUIZ', 
                'EXERCISE', 'REST', 'SOCIAL', 'EXERCISE', 
                'QUIZ', 'ATTACK', 'SOCIAL', 'EXERCISE', 
                'QUIZ', 'CHANCE', 'EXERCISE'
            ];
            
            board.push({ id: 0, type: 'START', ...TILE_TYPES.START });
            types.forEach((type, index) => {
                board.push({ id: index + 1, type, ...TILE_TYPES[type] });
            });
            return board;
        };

        const BOARD_DATA = generateBoard();

        // åº§æ¨™è¨ˆç®— (ç¶­æŒæ­£æ–¹å½¢å›å­—å‹)
        const getGridPosition = (index) => {
            if (index >= 0 && index <= 5) return { row: 6, col: index + 1 };
            if (index >= 6 && index <= 10) return { row: 6 - (index - 5), col: 6 };
            if (index >= 11 && index <= 15) return { row: 1, col: 6 - (index - 10) };
            if (index >= 16 && index <= 19) return { row: 1 + (index - 15), col: 1 };
            return { row: 1, col: 1 };
        };

        const TEAM_COLORS = [
            { name: 'ç´…éšŠ', bg: 'bg-red-600', text: 'text-red-700', border: 'border-red-600', ring: 'ring-red-300', placeholder: 'ä¾‹å¦‚: ç´…éšŠ' },
            { name: 'è—éšŠ', bg: 'bg-blue-700', text: 'text-blue-700', border: 'border-blue-700', ring: 'ring-blue-300', placeholder: 'ä¾‹å¦‚: è—éšŠ' },
            { name: 'é»ƒéšŠ', bg: 'bg-yellow-500', text: 'text-yellow-700', border: 'border-yellow-500', ring: 'ring-yellow-300', placeholder: 'ä¾‹å¦‚: é»ƒéšŠ' },
            { name: 'ç¶ éšŠ', bg: 'bg-green-600', text: 'text-green-700', border: 'border-green-600', ring: 'ring-green-300', placeholder: 'ä¾‹å¦‚: ç¶ éšŠ' },
        ];


        // ----------------------------------------------------------------
        // 3. ä¸»è¦ React å…ƒä»¶ (ä½¿ç”¨ Babel ç·¨è­¯çš„ JSX)
        // ----------------------------------------------------------------

        function ElderMonopoly() {
            const [gameState, setGameState] = useState('SETUP');
            const [teams, setTeams] = useState([]);
            const [currentTeamIndex, setCurrentTeamIndex] = useState(0);
            const [diceNumber, setDiceNumber] = useState(1);
            const [isRolling, setIsRolling] = useState(false);
            const [currentTask, setCurrentTask] = useState(null);
            const [showConfetti, setShowConfetti] = useState(false);
            const [confettiText, setConfettiText] = useState('åŠ åˆ†ï¼ğŸ‰');
            const [setupTeamCount, setSetupTeamCount] = useState(2);
            const [customTeamNames, setCustomTeamNames] = useState(TEAM_COLORS.map(t => t.name));

            // éŸ³æ•ˆå‡½å¼
            const playSound = (type) => {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) return;
                    const ctx = new AudioContext();
                    const osc = ctx.createOscillator();
                    const gainNode = ctx.createGain();
                    osc.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    const now = ctx.currentTime;

                    if (type === 'success' || type === 'levelup') {
                        osc.type = 'triangle'; 
                        gainNode.gain.setValueAtTime(0.3, now);
                        osc.frequency.setValueAtTime(523.25, now);       
                        osc.frequency.setValueAtTime(659.25, now + 0.1); 
                        osc.frequency.setValueAtTime(783.99, now + 0.2); 
                        osc.frequency.setValueAtTime(1046.50, now + 0.3);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                        osc.start(now);
                        osc.stop(now + 0.8);
                    } else if (type === 'attack') {
                        osc.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.4, now);
                        osc.frequency.setValueAtTime(150, now);
                        osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                        osc.start(now);
                        osc.stop(now + 0.4);
                    } else if (type === 'tick') {
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(600, now);
                        osc.frequency.exponentialRampToValueAtTime(200, now + 0.05);
                        gainNode.gain.setValueAtTime(0.1, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                        osc.start(now);
                        osc.stop(now + 0.05);
                    }
                } catch (e) {
                    console.error("Audio play failed", e);
                }
            };

            const handleTeamNameChange = (index, value) => {
                const newNames = [...customTeamNames];
                newNames[index] = value;
                setCustomTeamNames(newNames);
            };

            const startGame = () => {
                const newTeams = Array.from({ length: setupTeamCount }, (_, i) => ({
                    id: i,
                    name: customTeamNames[i] || TEAM_COLORS[i].name, 
                    color: TEAM_COLORS[i],
                    position: 0,
                    score: 0,
                    laps: 0 
                }));
                setTeams(newTeams);
                setGameState('PLAYING');
            };

            const nextTurn = useCallback(() => {
                setCurrentTeamIndex((prev) => (prev + 1) % teams.length);
            }, [teams.length]);


            const triggerTileEvent = useCallback((tile, team) => {
                setTimeout(() => {
                    if (tile.type === 'START') {
                        nextTurn();
                    } else if (tile.type === 'REST') {
                        setCurrentTask({
                            type: 'REST',
                            title: 'ä¼‘æ¯ç«™',
                            content: 'å¤§å®¶å–å£æ°´ï¼Œæ·±å‘¼å¸ï¼Œä¼‘æ¯ä¸€ä¸‹ï¼',
                            points: 10,
                            teamName: team.name
                        });
                        setGameState('MODAL');
                    } else {
                        const categoryTasks = TASK_DATABASE[tile.type] || TASK_DATABASE.EXERCISE;
                        const randomTask = categoryTasks[Math.floor(Math.random() * categoryTasks.length)];
                        
                        setCurrentTask({
                            type: tile.type,
                            title: TILE_TYPES[tile.type].label,
                            content: randomTask.text,
                            answer: randomTask.answer,
                            points: randomTask.points,
                            effect: randomTask.effect,
                            teamName: team.name,
                            teamColor: team.color
                        });
                        setGameState('MODAL');
                    }
                }, 200);
            }, [nextTurn]);

            const movePlayer = useCallback((steps) => {
                // ç‚ºäº†æ­£ç¢ºè™•ç†ç•°æ­¥ç‹€æ…‹æ›´æ–°ä¸­çš„å‹•ç•«å’Œæœ€çµ‚ä½ç½®è¨ˆç®—ï¼Œæˆ‘å€‘éœ€è¦å…ˆç²å–ç•¶å‰éšŠä¼ç‹€æ…‹
                const startTeam = teams[currentTeamIndex];
                let stepsRemaining = steps;
                
                const stepInterval = setInterval(() => {
                    setTeams(prev => {
                        const newTeams = [...prev];
                        const team = { ...newTeams[currentTeamIndex] };
                        
                        // ç§»å‹•ä¸€æ­¥
                        team.position += 1;
                        
                        // è™•ç†ç¶“éèµ·é» (Wrap around)
                        let passedStart = false;
                        if (team.position >= BOARD_DATA.length) {
                            team.position = 0;
                            team.score += 50; 
                            team.laps += 1;
                            passedStart = true;
                        }
                        
                        if (passedStart) {
                            playSound('levelup');
                            setConfettiText('é€šéèµ·é» +50ï¼');
                            setShowConfetti(true);
                            setTimeout(() => setShowConfetti(false), 2000);
                        } else {
                            playSound('tick'); 
                        }
                        
                        newTeams[currentTeamIndex] = team;
                        return newTeams;
                    });

                    stepsRemaining--;

                    if (stepsRemaining <= 0) {
                        clearInterval(stepInterval);
                        
                        // è¨ˆç®—æœ€çµ‚ä½ç½®
                        let finalPos = startTeam.position + steps;
                        while (finalPos >= BOARD_DATA.length) {
                            finalPos -= BOARD_DATA.length;
                        }

                        // è§¸ç™¼æ ¼å­äº‹ä»¶
                        setTimeout(() => {
                            setShowConfetti(false);
                            triggerTileEvent(BOARD_DATA[finalPos], startTeam);
                        }, 500);
                    }
                }, 400); // æ¯ 0.4 ç§’èµ°ä¸€æ­¥
            }, [currentTeamIndex, teams, triggerTileEvent]);

            const rollDice = () => {
                if (isRolling) return;
                setIsRolling(true);
                let counter = 0;
                const interval = setInterval(() => {
                    playSound('tick');
                    setDiceNumber(Math.floor(Math.random() * 6) + 1);
                    counter++;
                    if (counter > 15) {
                        clearInterval(interval);
                        const finalDice = Math.floor(Math.random() * 6) + 1;
                        setDiceNumber(finalDice);
                        setIsRolling(false);
                        movePlayer(finalDice);
                    }
                }, 100);
            };

            // åŸ·è¡Œä»»å‹™èˆ‡æ‰£åˆ†é‚è¼¯
            const completeTask = (success) => {
                if (success) {
                    setTeams(prev => {
                        const newTeams = [...prev];
                        const currentTeam = newTeams[currentTeamIndex];
                        
                        // è™•ç†ç‰¹æ®Šæ”»æ“Šæ•ˆæœ
                        if (currentTask.type === 'ATTACK' && currentTask.effect) {
                            let targetName = "";
                            playSound('attack');

                            switch (currentTask.effect) {
                                case 'NEXT': // ä¸‹ä¸€ä½
                                    const nextIndex = (currentTeamIndex + 1) % newTeams.length;
                                    newTeams[nextIndex].score += currentTask.points; 
                                    targetName = newTeams[nextIndex].name;
                                    break;
                                case 'PREV': // ä¸Šä¸€ä½
                                    const prevIndex = (currentTeamIndex - 1 + newTeams.length) % newTeams.length;
                                    newTeams[prevIndex].score += currentTask.points;
                                    targetName = newTeams[prevIndex].name;
                                    break;
                                case 'LEADER': // æœ€é«˜åˆ† (æ’é™¤è‡ªå·±)
                                    let maxScore = -9999;
                                    let leaderIndices = [];
                                    newTeams.forEach((t, i) => {
                                        if (i !== currentTeamIndex) {
                                            if (t.score > maxScore) {
                                                maxScore = t.score;
                                                leaderIndices = [i];
                                            } else if (t.score === maxScore) {
                                                leaderIndices.push(i);
                                            }
                                        }
                                    });
                                    if (leaderIndices.length > 0) {
                                        const targetIdx = leaderIndices[Math.floor(Math.random() * leaderIndices.length)];
                                        newTeams[targetIdx].score += currentTask.points;
                                        targetName = newTeams[targetIdx].name;
                                    } else {
                                        targetName = "ç„¡";
                                    }
                                    break;
                                case 'OTHERS': // å…¶ä»–æ‰€æœ‰äºº
                                    newTeams.forEach((t, i) => {
                                        if (i !== currentTeamIndex) {
                                            t.score += currentTask.points;
                                        }
                                    });
                                    targetName = "å…¶ä»–æ‰€æœ‰éšŠä¼";
                                    break;
                                case 'SELF': // è‡ªå·±
                                    currentTeam.score += currentTask.points;
                                    targetName = "è‡ªå·±";
                                    break;
                                default:
                                    break;
                            }

                            setConfettiText(`${targetName} æ‰£åˆ†ï¼ğŸ’¥`);
                            setShowConfetti(true);
                            setTimeout(() => setShowConfetti(false), 2500);

                        } else {
                            // ä¸€èˆ¬åŠ åˆ†ä»»å‹™
                            currentTeam.score += currentTask.points;
                            playSound('success');
                            setConfettiText('å¥½æ£’ï¼åŠ åˆ†ï¼ğŸ‰');
                            setShowConfetti(true);
                            setTimeout(() => setShowConfetti(false), 2000);
                        }

                        return newTeams;
                    });
                }
                
                setGameState('PLAYING');
                setCurrentTask(null);
                nextTurn();
            };

            const endGame = () => {
                setGameState('FINISHED');
                setConfettiText('éŠæˆ²çµæŸï¼ğŸ†');
                setShowConfetti(true);
            };

            const resetGame = () => {
                setGameState('SETUP');
                setTeams([]);
                setCurrentTeamIndex(0);
                setShowConfetti(false);
            };

            const currentTeam = teams[currentTeamIndex] || {}; // ç¢ºä¿åœ¨ setup éšæ®µ currentTeam ä¸ç‚º null

            // ----------------------------------------------------------------
            // UI å…ƒä»¶ - è¨­å®šç•«é¢
            // ----------------------------------------------------------------
            if (gameState === 'SETUP') {
                return (
                    <div className="min-h-screen bg-yellow-50 flex flex-col items-center justify-center p-4">
                        <div className="bg-white p-8 md:p-12 rounded-[3rem] shadow-2xl max-w-3xl w-full text-center border-8 border-orange-400">
                            <h1 className="text-6xl md:text-7xl font-black text-orange-600 mb-6 tracking-wider drop-shadow-sm">é•·è€…é‹å‹•å¤§å¯Œç¿</h1>
                            
                            <div className="mb-8">
                                <h2 className="text-3xl md:text-4xl text-gray-700 font-bold mb-6">1. è«‹å•ä»Šå¤©æœ‰å¹¾çµ„åƒåŠ ï¼Ÿ</h2>
                                <div className="flex justify-center gap-6">
                                    {[2, 3, 4].map(num => (
                                        <button
                                            key={num}
                                            onClick={() => setSetupTeamCount(num)}
                                            className={`w-20 h-20 md:w-24 md:h-24 rounded-full text-4xl font-black transition-all transform hover:scale-110 ${
                                                setupTeamCount === num 
                                                ? 'bg-orange-500 text-white shadow-xl ring-8 ring-orange-200' 
                                                : 'bg-gray-200 text-gray-500 hover:bg-gray-300'
                                            }`}
                                        >
                                            {num}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="mb-10 bg-orange-50 p-6 rounded-3xl border-2 border-orange-100">
                                <h2 className="text-2xl md:text-3xl text-gray-700 font-bold mb-4">2. å¹«å„çµ„å–å€‹å¥½è½çš„åå­—ï¼š</h2>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {Array.from({ length: setupTeamCount }).map((_, index) => (
                                        <div key={index} className="flex items-center gap-2">
                                            <div className={`w-12 h-12 rounded-full border-4 border-white shadow-md flex items-center justify-center text-white font-bold text-xl shrink-0 ${TEAM_COLORS[index].bg}`}>
                                                {index + 1}
                                            </div>
                                            <input 
                                                type="text" 
                                                value={customTeamNames[index]}
                                                onChange={(e) => handleTeamNameChange(index, e.target.value)}
                                                placeholder={TEAM_COLORS[index].placeholder}
                                                className={`w-full text-2xl font-bold text-gray-700 p-3 rounded-xl border-4 outline-none focus:ring-4 transition-all ${TEAM_COLORS[index].border} focus:${TEAM_COLORS[index].ring}`}
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <button 
                                onClick={startGame}
                                className="w-full bg-green-600 hover:bg-green-700 text-white text-4xl font-black py-8 px-8 rounded-3xl shadow-[0_8px_0_rgb(21,128,61)] active:shadow-none active:translate-y-2 transition-all flex items-center justify-center gap-6"
                            >
                                <Play className="w-12 h-12 fill-current" />
                                é–‹å§‹éŠæˆ²
                            </button>
                        </div>
                    </div>
                );
            }

            // ----------------------------------------------------------------
            // UI å…ƒä»¶ - çµæŸç•«é¢
            // ----------------------------------------------------------------
            if (gameState === 'FINISHED') {
                const sortedTeams = [...teams].sort((a, b) => b.score - a.score);
                return (
                    <div className="min-h-screen bg-yellow-100 flex flex-col items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-4xl w-full text-center">
                            <h2 className="text-5xl font-black text-gray-800 mb-10">ğŸ† æ’è¡Œæ¦œ ğŸ†</h2>
                            <div className="space-y-6 mb-12">
                                {sortedTeams.map((team, index) => (
                                    <div key={team.id} className={`flex items-center p-6 rounded-2xl border-4 ${index === 0 ? 'bg-yellow-50 border-yellow-400 scale-105 shadow-xl' : 'bg-white border-gray-200'}`}>
                                        <div className={`w-20 h-20 rounded-full flex items-center justify-center text-4xl font-black text-white mr-6 ${index === 0 ? 'bg-yellow-400' : 'bg-gray-400'}`}>
                                            {index + 1}
                                        </div>
                                        <div className="flex-1 text-left">
                                            <div className={`text-4xl font-black ${team.color.text}`}>{team.name}</div>
                                        </div>
                                        <div className="text-6xl font-black text-gray-800">{team.score} <span className="text-3xl font-bold text-gray-500">åˆ†</span></div>
                                    </div>
                                ))}
                            </div>
                            <button 
                                onClick={resetGame}
                                className="bg-blue-600 text-white text-3xl font-bold py-6 px-16 rounded-full hover:bg-blue-700 shadow-xl"
                            >
                                å†ç©ä¸€æ¬¡
                            </button>
                        </div>
                    </div>
                );
            }

            // ----------------------------------------------------------------
            // UI å…ƒä»¶ - éŠæˆ²ä¸»ç•«é¢
            // ----------------------------------------------------------------

            return (
                <div className="h-screen w-screen bg-green-50 flex flex-col overflow-hidden select-none">
                    
                    {/* é ‚éƒ¨ */}
                    <header className="bg-white shadow-md p-2 flex justify-between items-center z-20 h-24 shrink-0">
                        <div className="flex items-center gap-4 pl-4">
                            <Activity className="text-orange-600 w-12 h-12" />
                            <h1 className="text-4xl font-black text-gray-800 tracking-wide hidden md:block">é•·è€…é‹å‹•å¤§å¯Œç¿</h1>
                        </div>
                        <div className="flex gap-6 pr-4 items-center">
                            {teams.map((team) => (
                                <div key={team.id} className={`hidden md:flex flex-col items-center px-6 py-2 rounded-2xl border-4 ${team.color.bg} border-white shadow-md min-w-[140px]`}>
                                    <span className="text-2xl text-white font-bold mb-1">{team.name}</span>
                                    <span className="text-5xl font-black text-white leading-none drop-shadow-md">{team.score}</span>
                                </div>
                            ))}
                            <button onClick={endGame} className="ml-2 px-8 py-4 bg-gray-200 rounded-full text-2xl text-gray-700 font-black hover:bg-gray-300 shadow-sm border-4 border-gray-300 transition-transform active:scale-95">
                                çµæŸ
                            </button>
                        </div>
                    </header>

                    {/* ä¸»ç•«é¢ */}
                    <main className="flex-1 relative flex items-center justify-center bg-green-100/50 p-2 md:p-4 overflow-hidden">
                        
                        <div className="relative aspect-square h-full max-h-[calc(100vh-5rem)] w-auto board-grid gap-2 md:gap-3 p-3 bg-white rounded-[2rem] shadow-2xl border-8 border-green-200">
                            
                            {/* ä¸­å¤®æ§åˆ¶å€ */}
                            <div className="col-start-2 col-span-4 row-start-2 row-span-4 bg-yellow-50/50 rounded-3xl flex flex-col items-center justify-center z-10 relative">
                                
                                <div className="flex flex-col items-center mb-3 md:mb-6 animate-in fade-in zoom-in duration-500">
                                    <div className="text-lg md:text-2xl font-bold text-gray-500 mb-1">ç¾åœ¨è¼ªåˆ°</div>
                                    <div className={`px-8 py-3 rounded-full text-4xl md:text-6xl font-black text-white shadow-lg tracking-widest ${currentTeam.color.bg} border-4 border-white`}>
                                        {currentTeam.name}
                                    </div>
                                </div>

                                <button 
                                    onClick={rollDice}
                                    disabled={isRolling}
                                    className={`
                                        relative group w-36 h-36 md:w-52 md:h-52 flex items-center justify-center rounded-[2rem] shadow-[0_12px_24px_rgba(0,0,0,0.15)] transition-all duration-200
                                        ${isRolling ? 'bg-gray-100 cursor-not-allowed scale-95' : 'bg-white hover:scale-105 cursor-pointer hover:shadow-[0_16px_32px_rgba(0,0,0,0.2)]'}
                                        border-4 md:border-8 border-orange-100
                                    `}
                                >
                                    <div className={`
                                        w-24 h-24 md:w-36 md:h-36 bg-white border-[4px] md:border-[6px] border-gray-800 rounded-2xl flex items-center justify-center shadow-inner
                                        ${isRolling ? 'animate-spin' : ''}
                                    `}>
                                        <span className={`text-6xl md:text-8xl font-black ${isRolling ? 'text-gray-300 blur-sm' : 'text-gray-800'}`}>
                                            {diceNumber}
                                        </span>
                                    </div>
                                    
                                    {!isRolling && (
                                        <div className="absolute -bottom-4 md:-bottom-6 bg-orange-500 text-white px-4 py-1.5 rounded-full text-base md:text-xl font-bold shadow-lg animate-bounce whitespace-nowrap">
                                            é»æˆ‘æ“²éª°å­
                                        </div>
                                    )}
                                </button>
                            </div>

                            {/* æ ¼å­æ¸²æŸ“ */}
                            {BOARD_DATA.map((tile, index) => {
                                const pos = getGridPosition(index);
                                const teamsHere = teams.filter(t => t.position === index);
                                const IconComponent = tile.icon; // å–å¾— Lucide Icon å…ƒä»¶
                                
                                return (
                                    <div 
                                        key={tile.id} 
                                        style={{ gridRow: pos.row, gridColumn: pos.col }}
                                        className={`
                                            relative rounded-xl md:rounded-2xl border-b-4 border-r-4 shadow-md flex flex-col items-center justify-center text-center transition-all
                                            ${tile.color} border-black/20
                                        `}
                                    >
                                        <div className="flex flex-col items-center justify-center h-full w-full p-1">
                                            <div className="mb-1 drop-shadow-md transform scale-90 md:scale-110">
                                                <IconComponent className="w-8 h-8 md:w-10 md:h-10 text-white" />
                                            </div>
                                            <div className="text-white font-black text-base md:text-2xl lg:text-3xl leading-none drop-shadow-md tracking-wide">
                                                {tile.label}
                                            </div>
                                        </div>

                                        <div className="absolute top-1 left-2 text-white/40 font-black text-xs md:text-lg">
                                            {index + 1}
                                        </div>

                                        {teamsHere.length > 0 && (
                                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-20">
                                                {/* éšŠä¼åœ–ç¤º (å·²æ”¾å¤§) */}
                                                <div className="flex -space-x-8 md:-space-x-12 bg-white/30 p-4 rounded-full backdrop-blur-sm shadow-xl border-2 border-white/50">
                                                    {teamsHere.map(t => (
                                                        <div key={t.id} className={`w-20 h-20 md:w-28 md:h-28 rounded-full border-4 border-white shadow-2xl flex items-center justify-center text-3xl md:text-5xl font-black text-white ${t.color.bg}`}>
                                                            {t.name[0]}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </main>

                    {/* ä»»å‹™å½ˆçª— */}
                    {gameState === 'MODAL' && currentTask && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-md animate-in fade-in duration-300">
                            <div className={`bg-white rounded-[2.5rem] shadow-2xl max-w-4xl w-full h-auto max-h-[90vh] flex flex-col overflow-hidden border-8 ${currentTask.type === 'ATTACK' ? 'border-red-500' : 'border-white'}`}>
                                
                                {/* å½ˆçª—æ¨™é¡Œåˆ—ï¼šæ”»æ“Šå¡é¡¯ç¤ºç´…è‰² */}
                                <div className={`${currentTask.type === 'ATTACK' ? 'bg-red-600' : (currentTask.teamColor ? currentTask.teamColor.bg : 'bg-gray-600')} p-8 text-white text-center shrink-0 shadow-md z-10`}>
                                    <div className="text-3xl font-bold opacity-90 mb-2">{currentTask.teamName}</div>
                                    <div className="text-6xl font-black tracking-widest drop-shadow-lg flex items-center justify-center gap-4">
                                        {currentTask.type === 'ATTACK' && <Flame className="w-16 h-16 animate-pulse" />}
                                        {currentTask.title}
                                        {currentTask.type === 'ATTACK' && <Flame className="w-16 h-16 animate-pulse" />}
                                    </div>
                                </div>
                                
                                <div className="p-10 flex-1 flex flex-col items-center justify-center text-center overflow-y-auto bg-yellow-50">
                                    <div className="w-full bg-white p-8 rounded-3xl shadow-sm border-4 border-yellow-200 mb-8">
                                        <p className="text-5xl md:text-6xl font-black text-gray-800 leading-tight">
                                            {currentTask.content}
                                        </p>
                                        
                                        {currentTask.answer && (
                                            <div className="mt-8 pt-8 border-t-4 border-dashed border-gray-200">
                                                <details className="group">
                                                    <summary className="cursor-pointer text-2xl text-blue-500 font-bold list-none p-4 hover:bg-blue-50 rounded-xl transition-colors">
                                                        é»é€™è£¡çœ‹ç­”æ¡ˆ
                                                    </summary>
                                                    <p className="mt-4 text-4xl font-bold text-green-600 bg-green-50 p-4 rounded-xl">{currentTask.answer}</p>
                                                </details>
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className={`text-4xl font-black px-8 py-2 rounded-full shadow-sm border-2 ${currentTask.type === 'ATTACK' ? 'text-red-600 bg-red-50 border-red-200' : 'text-orange-500 bg-white border-orange-100'}`}>
                                        {currentTask.type === 'ATTACK' ? 'ğŸ’¥ æ”»æ“Šæ•ˆæœ ğŸ’¥' : `çå‹µï¼š${currentTask.points} åˆ†`}
                                    </div>
                                </div>
                                
                                <div className="p-6 bg-white border-t flex gap-4 shrink-0">
                                    {currentTask.type === 'REST' ? (
                                        <button onClick={() => completeTask(true)} className="flex-1 bg-green-500 text-white text-3xl font-bold py-6 rounded-2xl shadow-lg active:scale-95 transition-transform">
                                            ä¼‘æ¯å¥½äº† (é ˜å–åˆ†æ•¸)
                                        </button>
                                    ) : currentTask.type === 'ATTACK' ? (
                                        // æ”»æ“Šå¡åªæœ‰ä¸€å€‹æŒ‰éˆ•
                                        <button onClick={() => completeTask(true)} className="flex-1 bg-red-600 hover:bg-red-700 text-white text-4xl font-bold py-6 rounded-2xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-3">
                                            <Swords className="w-10 h-10" />
                                            ç™¼å‹•æ”»æ“Šï¼
                                        </button>
                                    ) : (
                                        <>
                                            <button onClick={() => completeTask(false)} className="flex-1 bg-gray-400 text-white text-3xl font-bold py-6 rounded-2xl shadow active:scale-95 transition-transform">
                                                æ”¾æ£„ / å¤±æ•—
                                            </button>
                                            <button onClick={() => completeTask(true)} className="flex-[2] bg-green-600 text-white text-4xl font-bold py-6 rounded-2xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-3">
                                                <CheckCircle className="w-10 h-10" />
                                                ä»»å‹™å®Œæˆ
                                            </button>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {showConfetti && (
                        <div className="fixed inset-0 pointer-events-none z-[60] flex items-center justify-center">
                            <div className={`text-6xl md:text-8xl animate-bounce font-black drop-shadow-[0_4px_0_rgba(0,0,0,0.2)] bg-white border-8 px-12 py-8 rounded-full shadow-2xl text-center leading-tight ${confettiText.includes('æ‰£åˆ†') ? 'text-red-600 border-red-500' : 'text-yellow-500 border-yellow-400'}`}>
                                {confettiText}
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // 4. æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼ (ä¿®æ­£ç‚º React 18 çš„ createRoot API)
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ElderMonopoly />);

    </script>
</body>
</html>
